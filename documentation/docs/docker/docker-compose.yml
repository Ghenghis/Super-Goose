services:
  goose-cli:
    build:
      context: ../../..
      dockerfile: documentation/docs/docker/Dockerfile
      args:
        USER_ID: ${UID:-1000}
    volumes:
      # Mount user's directory with read-write access
      - ../../..:/root/workspace
      - goose-config:/root/.goose
      # Mount git config
      - ~/.gitconfig:/root/.gitconfig:ro
      # Mount SSH keys
      - ~/.ssh:/root/.ssh:ro
    working_dir: /root/workspace
    environment:
      - OOSE_HOME=/root/.goose
      # Set default editor
      - EDITOR=vim
      # Preserve git author info
      - GIT_AUTHOR_NAME=${GIT_AUTHOR_NAME:-Goose User}
      - GIT_AUTHOR_EMAIL=${GIT_AUTHOR_EMAIL:-goose@example.com}
      # Set GOOGLE_API_KEY to your own API key
      - GOOGLE_API_KEY="XXX"
      - GOOSE_PROVIDER=google
      - GOOSE_MODEL=gemini-2.0-flash-exp
      - DBUS_SESSION_BUS_ADDRESS
      - GNOME_KEYRING_CONTROL
      - SSH_AUTH_SOCK
    stdin_open: true
    tty: true
    entrypoint: ["/bin/bash"]

  goosed:
    build:
      context: ../../..
      dockerfile: documentation/docs/docker/Dockerfile
    entrypoint: ["/usr/local/bin/goosed", "agent"]
    ports:
      - "${GOOSE_PORT:-3284}:3284"
    environment:
      - GOOSE_PORT=3284
      - GOOSE_SERVER__HOST=0.0.0.0
      - GOOSE_HOME=/home/goose
    volumes:
      - goose-config:/home/goose/.config/goose
      - ${WORKSPACE:-./workspace}:/workspace
    restart: on-failure:10
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3284/api/version"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 4G

volumes:
  goose-config:
# E2E Test Audit Report - 2026-02-12

## Overview

Audit of all Playwright E2E test files under `ui/desktop/tests/e2e/`.
Branch: `feat/resizable-layout`

---

## Test Infrastructure

### Configuration Files

| File | Purpose |
|------|---------|
| `playwright.config.ts` | Main config: 60s timeout, serial execution (workers=1), two projects (with/without backend) |
| `global-setup.ts` | Kills zombie goosed.exe processes, sets env vars (runs once before all tests) |
| `skip-utils.ts` | `skipWithoutBackend()`, `skipWithBackend()`, `skipUnless()`, `skipIf()`, `getBackendUrl()` |
| `fixtures.ts` | Electron app fixture: launches fresh Electron app per test via `electron-forge start` |
| `backend-fixture.ts` | Backend management fixture: health checks, optional auto-start of goosed |
| `test-overlay.ts` | Visual overlay showing current test name on the Electron window |
| `panels/panel-test-utils.ts` | Shared helpers: `waitForAppReady()`, `navigateToRoute()`, `verifyPanelHeader()`, etc. |
| `basic-mcp.ts` | MCP test server (Running Quotes) for extension integration tests |

### Projects in playwright.config.ts

- **without-backend**: Runs tests whose names do NOT contain "backend" (default)
- **with-backend**: Runs tests whose names contain "backend" (requires `GOOSE_BACKEND=1`)

### npm Scripts

```
test-e2e              - Run all E2E tests
test-e2e:dev          - Dev mode (list reporter, no retries, fail-fast)
test-e2e:ui           - Playwright UI mode
test-e2e:debug        - Debug mode
test-e2e:backend      - Backend tests only
test-e2e:backend-health - Health check tests only
test-e2e:no-backend   - Non-backend tests only
```

---

## Spec File Inventory

### Root-level Spec Files

| File | Tests | Backend Required | Skip Pattern | Status |
|------|-------|-----------------|--------------|--------|
| `app.spec.ts` | 5 tests (1 UI + 4 backend) | Partial | `skipWithoutBackend` in beforeEach for Provider group | OK |
| `chat-features.spec.ts` | 14 tests | YES (all) | `skipWithoutBackend` in beforeEach | OK |
| `coding-workflow.spec.ts` | 5 tests | YES (all) | `skipWithoutBackend` in beforeEach | OK |
| `context-management.spec.ts` | 8 tests | YES (all) | `skipWithoutBackend` in beforeEach | OK |
| `enhanced-context-management.spec.ts` | 14 tests | YES (all) | `skipWithoutBackend` in beforeEach | OK |
| `performance.spec.ts` | 3 tests | YES (all) | `skipWithoutBackend` in beforeEach | OK |
| `tic-tac-toe.spec.ts` | 1 test | YES | `skipWithoutBackend` in beforeEach | OK |
| `backend-example.spec.ts` | 7 tests | Partial (3 groups skip, 2 adaptive) | Mixed: `skipWithoutBackend` + runtime checks | OK |
| `backend-health.spec.ts` | 10 tests | YES (most) | `skipWithoutBackend` in beforeEach + runtime checks | OK |

### Panel Spec Files (in `panels/`)

| File | Tests | Backend Required | Status |
|------|-------|-----------------|--------|
| `agent-panel.spec.ts` | UI panel tests | NO | OK - standalone |
| `cli-panel.spec.ts` | CLI panel tests | NO | OK - standalone |
| `conscious-panel.spec.ts` | Conscious panel tests | NO | OK - standalone |
| `enterprise-panel.spec.ts` | Enterprise panel tests | NO | OK - standalone |
| `feature-panels.spec.ts` | 8 panel routes | NO | OK - standalone |
| `timewarp-bar.spec.ts` | TimeWarp panel tests | NO | OK - standalone |
| `tools-panel.spec.ts` | Tools panel tests | NO | OK - standalone |

---

## Issues Found and Fixed

### 1. Untyped `catch` blocks accessing `.message` / `.code` (12 instances, 5 files)

**Problem**: Multiple `catch (error)` blocks accessed `error.message` or `error.code` without
type annotations. Under strict TypeScript (`useUnknownInCatchVariables`), `error` is typed as
`unknown`, and property access without narrowing is a type error.

**Files Fixed**:
- `global-setup.ts` - 3 catch blocks (lines 47, 60, 69)
- `fixtures.ts` - 3 catch blocks (lines 84, 116, 162)
- `backend-fixture.ts` - 3 catch blocks (lines 63, 131, 169)
- `backend-example.spec.ts` - 1 catch block (line 118)
- `backend-health.spec.ts` - 1 catch block (line 110)

**Fix**: Added explicit `catch (error: unknown)` or `catch (_error: unknown)` annotations,
and used type narrowing via `error instanceof Error ? error.message : String(error)` or
type assertions `as { code?: string; message?: string }` where process error shapes were needed.

### 2. Inline `require('fs')` in app.spec.ts

**Problem**: `app.spec.ts` used `const fs = require('fs')` inline (line 367) instead of a
top-level import, mixing CJS require with ESM imports.

**Fix**: Added `import { existsSync, mkdirSync } from 'fs'` at the top of the file and
replaced the inline `require` with direct function calls.

### 3. Unused `error` variable in catch block (app.spec.ts)

**Problem**: Line 378 had `catch (error)` with an unused `error` variable.

**Fix**: Renamed to `catch (_error: unknown)` to indicate intentional discard and add type annotation.

---

## Architecture Observations

### Fixture Design

The fixture system is well-designed with proper separation:
- `fixtures.ts` handles Electron app lifecycle (launch, connect via CDP, teardown)
- `backend-fixture.ts` handles goosed server lifecycle (health checks, auto-start)
- Panel tests use the app fixture but NOT the backend fixture (UI-only)

### Skip Pattern Usage

All backend-dependent tests correctly use `skipWithoutBackend(test)`. The pattern is:
```typescript
test.beforeEach(() => {
  skipWithoutBackend(test);
});
```

Two files (`backend-example.spec.ts`, `backend-health.spec.ts`) additionally use runtime
`isBackendRunning` checks for adaptive test behavior, which is a good pattern for tests
that can partially run without a backend.

### Timeout Configuration

- Global test timeout: 60s (playwright.config.ts)
- Global expect timeout: 30s
- Action/navigation timeout: 30s
- Individual test overrides:
  - `coding-workflow.spec.ts`: 180s (3 min) per test
  - `tic-tac-toe.spec.ts`: 300s (5 min) per test
  - `performance.spec.ts`: uses default 60s

These timeouts are appropriate for LLM-backed tests that wait for AI responses.

### Process Cleanup

- `global-setup.ts` kills zombie `goosed.exe` / `goosed` before test runs (platform-aware)
- `fixtures.ts` kills Electron process tree after each test (platform-aware: `taskkill /F /T` on Windows, `process.kill(-pid, 'SIGKILL')` on Unix)
- `backend-fixture.ts` kills auto-started backend in teardown

---

## Tests That Require Backend vs Standalone

### Standalone (no backend needed) - ~7+ panel spec files
These test UI rendering via the Electron app fixture only:
- `app.spec.ts` > General UI > dark mode toggle
- All files in `panels/` directory

### Backend Required - 8 spec files, ~62 tests
These send real prompts to goosed and wait for AI responses:
- `app.spec.ts` > Provider tests (chat, MCP)
- `chat-features.spec.ts` (14 tests)
- `coding-workflow.spec.ts` (5 tests)
- `context-management.spec.ts` (8 tests)
- `enhanced-context-management.spec.ts` (14 tests)
- `performance.spec.ts` (3 tests)
- `tic-tac-toe.spec.ts` (1 test)
- `backend-example.spec.ts` (partial)
- `backend-health.spec.ts` (most)

---

## Recommendations for CI

### 1. Run Non-Backend Tests in CI (currently feasible)
```bash
npm run test-e2e:no-backend
```
This runs panel tests and the dark mode toggle test. Requires a built Electron app.

### 2. Backend Tests in CI (requires infrastructure)
```bash
GOOSE_BACKEND=1 GOOSE_BACKEND_URL=http://localhost:3284 npm run test-e2e
```
Requires:
- A running `goosed` binary with a configured LLM provider
- API key in environment (e.g., `DATABRICKS_TOKEN`)
- Sufficient timeout for AI responses (already configured)

### 3. Recommended CI Strategy
1. **PR checks**: Run `test-e2e:no-backend` (fast, no external dependencies)
2. **Nightly/staging**: Run full suite with `GOOSE_START_BACKEND=1` and a test LLM provider
3. **Pre-release**: Full suite including performance benchmarks

### 4. Known Pre-requisites
- Electron app must be built first (`npm run make` or `electron-forge start`)
- On Windows: `taskkill` is used for process cleanup (available by default)
- On macOS/Linux: `pkill` is used for process cleanup
- Node.js v24 or lower recommended (v25+ has cross-zip compatibility issues)

---

## Summary

| Metric | Count |
|--------|-------|
| Total spec files | 16 (9 root + 7 panels) |
| Total test cases | ~69+ root + panel tests |
| Backend-required | ~62 tests |
| Standalone | ~7+ tests |
| Files fixed | 6 files |
| Issues fixed | 15 individual fixes |
| Broken tests | 0 (all tests are structurally valid) |
| Missing skip patterns | 0 (all backend tests properly use `skipWithoutBackend`) |

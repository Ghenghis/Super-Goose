# Goose Project - GitLab CI/CD Pipeline with SonarQube Quality Gates

stages:
  - lint
  - test
  - analyze
  - quality-gate

variables:
  SONAR_HOST_URL: "http://sonarqube:9000"
  SONAR_TOKEN: "squ_5ace7604663a5576e548d3e2ee222616b1a30f0a"
  CARGO_HOME: "${CI_PROJECT_DIR}/.cargo"
  npm_config_cache: "${CI_PROJECT_DIR}/.npm"

# Cache dependencies
.cache_template: &cache_template
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - ui/desktop/node_modules/
      - .npm/
      - .cargo/
      - crates/target/

# Lint TypeScript
lint-typescript:
  stage: lint
  image: node:18
  <<: *cache_template
  script:
    - cd ui/desktop
    - npm ci
    - npm run lint
  allow_failure: false

# Lint Rust
lint-rust:
  stage: lint
  image: rust:latest
  <<: *cache_template
  script:
    - cd crates
    - cargo clippy --all-targets --all-features -- -D warnings
  allow_failure: false

# Test TypeScript with coverage
test-typescript:
  stage: test
  image: node:18
  <<: *cache_template
  dependencies:
    - lint-typescript
  script:
    - cd ui/desktop
    - npm ci
    - npm test -- --coverage
  artifacts:
    paths:
      - ui/desktop/coverage/
    reports:
      coverage_report:
        coverage_format: cobertura
        path: ui/desktop/coverage/cobertura-coverage.xml
    expire_in: 1 week
  coverage: '/Lines\s+:\s+(\d+\.\d+)%/'

# Test Rust with coverage
test-rust:
  stage: test
  image: rust:latest
  <<: *cache_template
  dependencies:
    - lint-rust
  before_script:
    - rustup component add llvm-tools-preview
    - cargo install cargo-llvm-cov --locked
  script:
    - cd crates
    - cargo llvm-cov --all-features --lcov --output-path target/coverage/lcov.info
    - cargo llvm-cov report --summary-only
  artifacts:
    paths:
      - crates/target/coverage/
    expire_in: 1 week
  coverage: '/TOTAL.*\s+(\d+\.\d+)%/'

# SonarQube analysis for TypeScript
sonarqube-typescript:
  stage: analyze
  image: sonarsource/sonar-scanner-cli:latest
  dependencies:
    - test-typescript
  script:
    - sonar-scanner
      -Dsonar.projectKey=goose-ui
      -Dsonar.sources=ui/desktop/src
      -Dsonar.tests=ui/desktop/src
      -Dsonar.test.inclusions=**/*.test.ts,**/*.test.tsx,**/*.spec.ts,**/*.spec.tsx
      -Dsonar.exclusions=**/node_modules/**,**/dist/**,**/build/**
      -Dsonar.host.url=$SONAR_HOST_URL
      -Dsonar.token=$SONAR_TOKEN
      -Dsonar.javascript.lcov.reportPaths=ui/desktop/coverage/lcov.info
      -Dsonar.sourceEncoding=UTF-8
  allow_failure: false
  only:
    - main
    - merge_requests

# SonarQube analysis for Rust
sonarqube-rust:
  stage: analyze
  image: sonarsource/sonar-scanner-cli:latest
  dependencies:
    - test-rust
  script:
    - sonar-scanner
      -Dsonar.projectKey=goose-rust
      -Dsonar.sources=crates
      -Dsonar.tests=crates
      -Dsonar.test.inclusions=**/tests/**/*.rs
      -Dsonar.exclusions=**/target/**,**/Cargo.lock
      -Dsonar.host.url=$SONAR_HOST_URL
      -Dsonar.token=$SONAR_TOKEN
      -Dsonar.rust.lcov.reportPaths=crates/target/coverage/lcov.info
      -Dsonar.sourceEncoding=UTF-8
  allow_failure: false
  only:
    - main
    - merge_requests

# Quality gate check - TypeScript
quality-gate-typescript:
  stage: quality-gate
  image: curlimages/curl:latest
  dependencies:
    - sonarqube-typescript
  script:
    - |
      echo "Checking TypeScript quality gate..."
      sleep 10  # Wait for SonarQube to process the report

      STATUS=$(curl -s -u "$SONAR_TOKEN:" \
        "$SONAR_HOST_URL/api/qualitygates/project_status?projectKey=goose-ui" \
        | grep -o '"status":"[^"]*"' | head -1 | cut -d'"' -f4)

      echo "Quality gate status: $STATUS"

      if [ "$STATUS" = "ERROR" ]; then
        echo "❌ Quality gate FAILED for TypeScript project"
        echo "View details: $SONAR_HOST_URL/dashboard?id=goose-ui"
        exit 1
      fi

      echo "✅ Quality gate PASSED for TypeScript project"
  allow_failure: false
  only:
    - main
    - merge_requests

# Quality gate check - Rust
quality-gate-rust:
  stage: quality-gate
  image: curlimages/curl:latest
  dependencies:
    - sonarqube-rust
  script:
    - |
      echo "Checking Rust quality gate..."
      sleep 10  # Wait for SonarQube to process the report

      STATUS=$(curl -s -u "$SONAR_TOKEN:" \
        "$SONAR_HOST_URL/api/qualitygates/project_status?projectKey=goose-rust" \
        | grep -o '"status":"[^"]*"' | head -1 | cut -d'"' -f4)

      echo "Quality gate status: $STATUS"

      if [ "$STATUS" = "ERROR" ]; then
        echo "❌ Quality gate FAILED for Rust project"
        echo "View details: $SONAR_HOST_URL/dashboard?id=goose-rust"
        exit 1
      fi

      echo "✅ Quality gate PASSED for Rust project"
  allow_failure: false
  only:
    - main
    - merge_requests

# Optional: Build artifacts (only after quality gates pass)
build:
  stage: .post
  image: node:18
  <<: *cache_template
  script:
    - cd ui/desktop
    - npm ci
    - npm run build
  artifacts:
    paths:
      - ui/desktop/dist/
    expire_in: 1 week
  only:
    - main
    - tags

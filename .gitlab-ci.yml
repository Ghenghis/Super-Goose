# GitLab CI/CD Pipeline for Goose
# Replaces GitHub Actions — runs free locally via gitlab-runner
#
# Local usage:
#   gitlab-runner exec docker rust-format
#   gitlab-runner exec docker rust-lint
#   gitlab-runner exec docker rust-build-test
#   gitlab-runner exec shell rust-build-test-local   (Windows, no Docker)
#
# Full local CI (PowerShell):
#   .\scripts\local-ci.ps1

stages:
  - check
  - test
  - build
  - release

variables:
  CARGO_HOME: $CI_PROJECT_DIR/.cargo
  CARGO_INCREMENTAL: "0"
  RUST_MIN_STACK: "8388608"

# ─── Shared Templates ───────────────────────────────────────────

.rust_image:
  image: rust:1.86
  before_script:
    - apt-get update -y && apt-get install -y libdbus-1-dev libxcb1-dev gnome-keyring
    - rustup component add clippy rustfmt

.cache_cargo: &cache_cargo
  cache:
    key: cargo-${CI_COMMIT_REF_SLUG}
    paths:
      - .cargo/registry/
      - .cargo/git/
      - target/

.cache_npm: &cache_npm
  cache:
    key: npm-${CI_COMMIT_REF_SLUG}
    paths:
      - ui/desktop/node_modules/

# Only run on code changes (skip docs-only commits)
.skip_docs_only:
  rules:
    - changes:
        - "documentation/**"
      when: never
    - when: on_success

# ─── Stage: check ───────────────────────────────────────────────

rust-format:
  stage: check
  extends: [.rust_image, .skip_docs_only]
  <<: *cache_cargo
  script:
    - cargo fmt --check
  allow_failure: false

rust-lint:
  stage: check
  extends: [.rust_image, .skip_docs_only]
  <<: *cache_cargo
  script:
    - cargo clippy --all-targets -- -D warnings
  allow_failure: false

openapi-schema-check:
  stage: check
  extends: [.rust_image, .skip_docs_only]
  <<: *cache_cargo
  script:
    - cargo run -p goose-server --bin generate_schema
    - cd ui/desktop && npm ci && npx @hey-api/openapi-ts && cd ../..
    - |
      if ! git diff --ignore-space-change --exit-code ui/desktop/openapi.json ui/desktop/src/api/; then
        echo "❌ OpenAPI schema is out of date! Run: just generate-openapi"
        exit 1
      fi
      echo "✅ OpenAPI schema is up-to-date"

desktop-lint:
  stage: check
  image: node:24
  extends: .skip_docs_only
  <<: *cache_npm
  script:
    - cd ui/desktop
    - npm ci
    - npm run lint:check
    - npm run test:run

# ─── Stage: test ────────────────────────────────────────────────

rust-build-test:
  stage: test
  extends: [.rust_image, .skip_docs_only]
  <<: *cache_cargo
  timeout: 60 minutes
  script:
    - gnome-keyring-daemon --components=secrets --daemonize --unlock <<< 'foobar'
    - cd crates && cargo test -- --skip scenario_tests::scenarios::tests

rust-scenario-tests:
  stage: test
  extends: [.rust_image, .skip_docs_only]
  <<: *cache_cargo
  timeout: 45 minutes
  script:
    - gnome-keyring-daemon --components=secrets --daemonize --unlock <<< 'foobar'
    - cd crates && cargo test --jobs 1 scenario_tests::scenarios::tests
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: on_success
    - when: never

# ─── Stage: build (tags and main only) ──────────────────────────

# Windows Portable CLI (local Windows runner)
build-windows-portable:
  stage: build
  tags: [windows, local]
  <<: *cache_cargo
  script:
    - cargo build --release --bin goose --bin goosed
    - mkdir -p build-output/goose-portable-windows-x64
    - cp target/release/goose.exe build-output/goose-portable-windows-x64/
    - cp target/release/goosed.exe build-output/goose-portable-windows-x64/
    - cp README.md LICENSE build-output/goose-portable-windows-x64/
    - cd build-output
    - powershell -Command "Compress-Archive -Path goose-portable-windows-x64 -DestinationPath goose-portable-windows-x64.zip -Force"
  artifacts:
    paths:
      - build-output/*.zip
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"

# Windows Desktop Build (local Windows runner)
build-windows-desktop:
  stage: build
  tags: [windows, local]
  <<: *cache_cargo
  script:
    - cargo build --release --bin goosed
    - mkdir -p ui/desktop/src/bin
    - cp target/release/goosed.exe ui/desktop/src/bin/
    - cd ui/desktop
    - npm ci --legacy-peer-deps
    - npm run package
    - npm run make
  artifacts:
    paths:
      - ui/desktop/out/make/**/*.exe
      - ui/desktop/out/**/*.zip
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"

# Linux Portable CLI (Docker)
build-linux-portable:
  stage: build
  image: rust:1.86
  <<: *cache_cargo
  script:
    - apt-get update && apt-get install -y musl-tools
    - rustup target add x86_64-unknown-linux-musl
    - cargo build --release --target x86_64-unknown-linux-musl --bin goose --bin goosed
    - mkdir -p build-output/goose-portable-linux-x64
    - cp target/x86_64-unknown-linux-musl/release/goose build-output/goose-portable-linux-x64/
    - cp target/x86_64-unknown-linux-musl/release/goosed build-output/goose-portable-linux-x64/
    - cp README.md LICENSE build-output/goose-portable-linux-x64/
    - cd build-output && tar -czf goose-portable-linux-x64.tar.gz goose-portable-linux-x64
  artifacts:
    paths:
      - build-output/*.tar.gz
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"

# Docker Image Build
build-docker:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -t goose:${CI_COMMIT_TAG:-latest} .
    - docker save goose:${CI_COMMIT_TAG:-latest} | gzip > goose-docker.tar.gz
  artifacts:
    paths:
      - goose-docker*.tar.gz
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG

# ─── Stage: release (tags only) ─────────────────────────────────

create-release:
  stage: release
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq bash
  script:
    - echo "Creating GitLab release for ${CI_COMMIT_TAG}..."
  release:
    tag_name: $CI_COMMIT_TAG
    description: "Release $CI_COMMIT_TAG"
    assets:
      links:
        - name: Windows Portable CLI
          url: "${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/build-output/goose-portable-windows-x64.zip"
        - name: Linux Portable CLI
          url: "${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/build-output/goose-portable-linux-x64.tar.gz"
  needs:
    - build-windows-portable
    - build-linux-portable
    - build-docker
  rules:
    - if: $CI_COMMIT_TAG

# GitLab CI/CD Pipeline for Goose
# Run locally with: gitlab-runner exec docker <job-name>

stages:
  - build
  - package
  - release

variables:
  CARGO_HOME: $CI_PROJECT_DIR/.cargo
  RUST_VERSION: "1.75"

# Cache for faster builds
.cache_template: &cache_template
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .cargo/
      - target/
      - ui/desktop/node_modules/

# Windows Portable CLI Build (runs locally on Windows)
build-windows-portable:
  stage: build
  tags:
    - windows
    - local
  <<: *cache_template
  script:
    - echo "Building Windows portable CLI..."
    - cargo build --release --bin goose --bin goosed
    - mkdir -p build-output/goose-portable-windows-x64
    - cp target/release/goose.exe build-output/goose-portable-windows-x64/
    - cp target/release/goosed.exe build-output/goose-portable-windows-x64/
    - cp README.md LICENSE build-output/goose-portable-windows-x64/
    - cd build-output
    - powershell -Command "Compress-Archive -Path goose-portable-windows-x64 -DestinationPath goose-portable-windows-x64-v$CI_COMMIT_TAG.zip -Force"
  artifacts:
    paths:
      - build-output/*.zip
    expire_in: 1 week
  only:
    - tags
    - main

# Windows Desktop Build (runs locally on Windows)
build-windows-desktop:
  stage: build
  tags:
    - windows
    - local
  <<: *cache_template
  script:
    - echo "Building Windows desktop app..."
    - cargo build --release --bin goosed
    - mkdir -p ui/desktop/src/bin
    - cp target/release/goosed.exe ui/desktop/src/bin/
    - cd ui/desktop
    - npm ci --legacy-peer-deps
    - npm run package
    - npm run make
  artifacts:
    paths:
      - ui/desktop/out/make/**/*.exe
      - ui/desktop/out/**/*.zip
    expire_in: 1 week
  only:
    - tags
    - main

# Linux Portable CLI (runs in Docker)
build-linux-portable:
  stage: build
  image: rust:latest
  <<: *cache_template
  script:
    - apt-get update && apt-get install -y musl-tools
    - rustup target add x86_64-unknown-linux-musl
    - cargo build --release --target x86_64-unknown-linux-musl --bin goose --bin goosed
    - mkdir -p build-output/goose-portable-linux-x64
    - cp target/x86_64-unknown-linux-musl/release/goose build-output/goose-portable-linux-x64/
    - cp target/x86_64-unknown-linux-musl/release/goosed build-output/goose-portable-linux-x64/
    - cp README.md LICENSE build-output/goose-portable-linux-x64/
    - cd build-output
    - tar -czf goose-portable-linux-x64-v$CI_COMMIT_TAG.tar.gz goose-portable-linux-x64
  artifacts:
    paths:
      - build-output/*.tar.gz
    expire_in: 1 week
  only:
    - tags
    - main

# Docker Image Build
build-docker:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -t goose:$CI_COMMIT_TAG .
    - docker save goose:$CI_COMMIT_TAG | gzip > goose-docker-$CI_COMMIT_TAG.tar.gz
  artifacts:
    paths:
      - goose-docker-*.tar.gz
    expire_in: 1 week
  only:
    - tags

# Create GitHub Release
create-release:
  stage: release
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq bash
    - wget https://github.com/cli/cli/releases/download/v2.40.0/gh_2.40.0_linux_amd64.tar.gz
    - tar -xzf gh_2.40.0_linux_amd64.tar.gz
    - mv gh_2.40.0_linux_amd64/bin/gh /usr/local/bin/
  script:
    - echo "Uploading to GitHub release $CI_COMMIT_TAG..."
    - gh release upload $CI_COMMIT_TAG build-output/*.zip build-output/*.tar.gz --clobber || true
  dependencies:
    - build-windows-portable
    - build-windows-desktop
    - build-linux-portable
    - build-docker
  only:
    - tags

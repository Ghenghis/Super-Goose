name: CI (Redesigned - Smart & Fast)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

# Cancel in-progress runs for same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # STAGE 1: Detect what changed (< 10 seconds)
  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  detect-changes:
    name: ðŸ” Detect Changes
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      docs-only: ${{ steps.filter.outputs.docs-only }}
      rust-changed: ${{ steps.filter.outputs.rust }}
      typescript-changed: ${{ steps.filter.outputs.typescript }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36  # v3
        id: filter
        with:
          filters: |
            docs-only:
              - '**.md'
              - 'docs/**'
              - '!crates/**'
              - '!ui/**'
              - '!.github/**'
              - '!bin/**'
              - '!scripts/**'

            rust:
              - 'crates/**/*.rs'
              - 'Cargo.toml'
              - 'Cargo.lock'
              - 'bin/**'
              - 'scripts/**'

            typescript:
              - 'ui/**/*.ts'
              - 'ui/**/*.tsx'
              - 'ui/**/*.js'
              - 'ui/**/*.jsx'
              - 'ui/**/package.json'
              - 'ui/**/package-lock.json'

  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # DOCS ONLY PATH (fastest - 1-2 minutes)
  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  docs-check:
    name: ðŸ“ Documentation Check
    runs-on: ubuntu-latest
    timeout-minutes: 3
    needs: detect-changes
    if: needs.detect-changes.outputs.docs-only == 'true'
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: âœ… Documentation Only
        run: |
          echo "âœ… Only documentation files changed"
          echo "âœ… Skipping code builds and tests"
          echo "âœ… CI PASSED - Documentation changes require no testing"

  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # CODE PATH - STAGE 2: LINT (Fast fail - 2-5 minutes)
  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lint-rust:
    name: ðŸ¦€ Lint Rust Code
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: detect-changes
    if: needs.detect-changes.outputs.docs-only != 'true' && needs.detect-changes.outputs.rust-changed == 'true'
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c  # v1
        with:
          components: rustfmt, clippy

      - name: Cache Rust Dependencies
        uses: Swatinem/rust-cache@ad397744b0d591a723ab90405b7247fac0e6b8db  # v2
        with:
          cache-on-failure: true

      - name: Check Formatting
        run: cargo fmt --check

      - name: Run Clippy
        run: cargo clippy --all-targets -- -D warnings

  lint-typescript:
    name: ðŸ“¦ Lint TypeScript Code
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: detect-changes
    if: needs.detect-changes.outputs.docs-only != 'true' && needs.detect-changes.outputs.typescript-changed == 'true'
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: ui/desktop/package-lock.json

      - name: Install Dependencies
        # --force: skip platform checks for Windows-only rollup binaries in lockfile
        run: npm ci --force
        working-directory: ui/desktop

      - name: Run ESLint
        run: npm run lint:check
        working-directory: ui/desktop

  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # CODE PATH - STAGE 2b: CARGO QUALITY TOOLS (parallel with build)
  # NON-BLOCKING: continue-on-error lets this job warn without
  # failing CI. Remove continue-on-error once results are stable.
  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  cargo-tools:
    name: Cargo Quality Tools
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [detect-changes, lint-rust]
    if: needs.detect-changes.outputs.docs-only != 'true' && needs.detect-changes.outputs.rust-changed == 'true'
    continue-on-error: true
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4
        with:
          persist-credentials: false

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c  # v1

      - name: Cache Rust Dependencies
        uses: Swatinem/rust-cache@ad397744b0d591a723ab90405b7247fac0e6b8db  # v2
        with:
          cache-on-failure: true

      - name: Install System Dependencies
        run: |
          sudo apt update -y
          sudo apt install -y libdbus-1-dev gnome-keyring libxcb1-dev

      - name: Install cargo tools
        run: |
          cargo install cargo-machete --locked || true
          cargo install cargo-hack --locked || true

      - name: Check for unused dependencies
        run: cargo machete --skip-target-dir || echo "::warning::cargo-machete found unused dependencies"

      - name: Check no-default-features builds
        run: |
          cargo hack check --no-default-features -p goose-cli -p goose -p goose-server 2>&1 || echo "::warning::Some crates fail without default features"

      - name: Check all-features builds
        run: |
          cargo hack check --all-features -p goose-cli -p goose -p goose-server 2>&1 || echo "::warning::Some crates fail with all features"

  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # CODE PATH - STAGE 3: BUILD (3-10 minutes, parallel)
  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-rust:
    name: ðŸ”¨ Build Rust Project
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [detect-changes, lint-rust]
    if: needs.detect-changes.outputs.docs-only != 'true' && needs.detect-changes.outputs.rust-changed == 'true'
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c  # v1

      - name: Cache Rust Dependencies
        uses: Swatinem/rust-cache@ad397744b0d591a723ab90405b7247fac0e6b8db  # v2
        with:
          cache-on-failure: true

      - name: Install System Dependencies
        run: |
          sudo apt update -y
          sudo apt install -y libdbus-1-dev gnome-keyring libxcb1-dev

      - name: Build All Crates (Release)
        run: cargo build --all --release
        env:
          CARGO_INCREMENTAL: 0

  build-typescript:
    name: ðŸ”¨ Build TypeScript Project
    runs-on: ubuntu-latest
    timeout-minutes: 12
    needs: [detect-changes, lint-typescript]
    if: needs.detect-changes.outputs.docs-only != 'true' && needs.detect-changes.outputs.typescript-changed == 'true'
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: ui/desktop/package-lock.json

      - name: Install Dependencies
        # --force: skip platform checks for Windows-only rollup binaries in lockfile
        run: npm ci --force
        working-directory: ui/desktop

      - name: Typecheck Desktop App
        run: npx tsc --noEmit
        working-directory: ui/desktop

  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # CODE PATH - STAGE 4: TEST (5-15 minutes, parallel)
  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test-rust-unit:
    name: ðŸ§ª Test Rust (Unit Tests)
    runs-on: ubuntu-latest
    timeout-minutes: 12
    needs: [detect-changes, build-rust]
    if: needs.detect-changes.outputs.docs-only != 'true' && needs.detect-changes.outputs.rust-changed == 'true'
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c  # v1

      - name: Cache Rust Dependencies
        uses: Swatinem/rust-cache@ad397744b0d591a723ab90405b7247fac0e6b8db  # v2
        with:
          cache-on-failure: true

      - name: Install System Dependencies
        run: |
          sudo apt update -y
          sudo apt install -y libdbus-1-dev gnome-keyring libxcb1-dev

      - name: Run Unit Tests
        run: |
          gnome-keyring-daemon --components=secrets --daemonize --unlock <<< 'test'
          cargo test --lib --all -- --skip scenario_tests
        working-directory: crates
        env:
          RUST_BACKTRACE: 1
          RUST_MIN_STACK: 8388608
          CARGO_INCREMENTAL: 0

  test-rust-integration:
    name: ðŸ§ª Test Rust (Integration Tests)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [detect-changes, build-rust]
    if: needs.detect-changes.outputs.docs-only != 'true' && needs.detect-changes.outputs.rust-changed == 'true'
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c  # v1

      - name: Cache Rust Dependencies
        uses: Swatinem/rust-cache@ad397744b0d591a723ab90405b7247fac0e6b8db  # v2
        with:
          cache-on-failure: true

      - name: Install System Dependencies
        run: |
          sudo apt update -y
          sudo apt install -y libdbus-1-dev gnome-keyring libxcb1-dev

      - name: Run Integration Tests
        run: |
          gnome-keyring-daemon --components=secrets --daemonize --unlock <<< 'test'
          cargo test --test '*' --all -- --skip scenario_tests
        working-directory: crates
        env:
          RUST_BACKTRACE: 1
          RUST_MIN_STACK: 8388608
          CARGO_INCREMENTAL: 0

  test-typescript:
    name: ðŸ§ª Test TypeScript (Unit Tests)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [detect-changes, build-typescript]
    if: needs.detect-changes.outputs.docs-only != 'true' && needs.detect-changes.outputs.typescript-changed == 'true'
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: ui/desktop/package-lock.json

      - name: Install Dependencies
        # --force: skip platform checks for Windows-only rollup binaries in lockfile
        run: npm ci --force
        working-directory: ui/desktop

      - name: Run Tests
        run: npm run test:run
        working-directory: ui/desktop

  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # STAGE 4b: SEMGREP POLICY (non-blocking, parallel with tests)
  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  semgrep-policy:
    name: Semgrep Stage 6 Policy
    runs-on: ubuntu-latest
    if: github.repository == 'Ghenghis/Super-Goose'
    continue-on-error: true
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4
      - name: Install Semgrep
        run: pip install semgrep
      - name: Run Stage 6 policy
        run: |
          if [ -f .semgrep/stage6.yml ]; then
            semgrep scan --config .semgrep/stage6.yml --error
          else
            echo "No .semgrep/stage6.yml found, skipping"
          fi

  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # STAGE 5: FINAL STATUS (Always runs)
  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ci-status:
    name: âœ… CI Status
    runs-on: ubuntu-latest
    timeout-minutes: 2
    needs:
      - detect-changes
      - docs-check
      - cargo-tools
      - semgrep-policy
      - test-rust-unit
      - test-rust-integration
      - test-typescript
    if: always()
    steps:
      - name: Check CI Result
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "          CI STATUS SUMMARY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Changes Detected:"
          echo "  Docs Only: ${{ needs.detect-changes.outputs.docs-only }}"
          echo "  Rust Changed: ${{ needs.detect-changes.outputs.rust-changed }}"
          echo "  TypeScript Changed: ${{ needs.detect-changes.outputs.typescript-changed }}"
          echo ""
          echo "Job Results:"
          echo "  docs-check: ${{ needs.docs-check.result }}"
          echo "  cargo-tools: ${{ needs.cargo-tools.result }} (non-blocking)"
          echo "  semgrep-policy: ${{ needs.semgrep-policy.result }} (non-blocking)"
          echo "  test-rust-unit: ${{ needs.test-rust-unit.result }}"
          echo "  test-rust-integration: ${{ needs.test-rust-integration.result }}"
          echo "  test-typescript: ${{ needs.test-typescript.result }}"
          echo ""

          # Determine overall status
          # NOTE: cargo-tools and semgrep-policy use continue-on-error so their
          # failure does not block CI. Jobs that were skipped (because their
          # language didn't change) are treated as passing.
          FAILED=0

          # Docs-only path
          if [[ "${{ needs.docs-check.result }}" == "success" ]]; then
            echo "Docs check passed."
          fi

          # Rust jobs: fail only if they ran and didn't succeed
          for job in "test-rust-unit:${{ needs.test-rust-unit.result }}" \
                     "test-rust-integration:${{ needs.test-rust-integration.result }}"; do
            JOB_NAME="${job%%:*}"
            RESULT="${job##*:}"
            if [[ "$RESULT" != "success" && "$RESULT" != "skipped" ]]; then
              echo "FAIL: ${JOB_NAME} = ${RESULT}"
              FAILED=1
            fi
          done

          # TypeScript jobs: fail only if they ran and didn't succeed
          TS_RESULT="${{ needs.test-typescript.result }}"
          if [[ "$TS_RESULT" != "success" && "$TS_RESULT" != "skipped" ]]; then
            echo "FAIL: test-typescript = ${TS_RESULT}"
            FAILED=1
          fi

          if [[ "$FAILED" == "1" ]]; then
            echo "âŒ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âŒ          CI FAILED - CHECK LOGS ABOVE            "
            echo "âŒ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 1
          else
            echo "âœ… â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âœ…          CI PASSED - ALL CHECKS SUCCESSFUL        "
            echo "âœ… â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 0
          fi
